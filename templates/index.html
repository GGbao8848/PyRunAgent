<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>PyRunAgent Web</title>
  <link rel="stylesheet" href="/static/style.css" />
</head>
<body>
  <div class="container">
    <h1>ğŸ§© PyRunAgent - Pythonè„šæœ¬è¿è¡Œä»£ç†å·¥å…·ç®±</h1>

    <div class="block">
      <label>Python ç¯å¢ƒè·¯å¾„ï¼š</label>
      <input id="python_path" type="text" placeholder="/path/to/conda/env/bin/python">
    </div>

    <div class="block">
      <label>è„šæœ¬ç›®å½•ï¼š</label>
      <input id="dir_input" type="text" placeholder="/path/to/scripts">
      <button onclick="scan()">æ‰«æ</button>
    </div>

    <div class="block">
      <label>è„šæœ¬åˆ—è¡¨ï¼š</label>
      <select id="script_list" onchange="loadArgs()"></select>
    </div>

    <div class="block">
      <label>å‚æ•°ï¼š</label>
      <textarea id="args_input" placeholder="ä¾‹å¦‚: --input ./data --epochs 10"></textarea>
      <button onclick="run()">è¿è¡Œ</button>
    </div>

    <div class="block">
      <label>è¾“å‡ºï¼š</label>
      <pre id="output"></pre>
    </div>
  </div>

  <script>
    async function scan() {
      const dir = document.getElementById("dir_input").value;
      const res = await fetch("/scan", {
        method: "POST",
        body: new URLSearchParams({ dir }),
      });
      const data = await res.json();
      const list = document.getElementById("script_list");
      list.innerHTML = "";
      (data.scripts || []).forEach(s => {
        const opt = document.createElement("option");
        opt.value = s.path;
        opt.textContent = s.name;
        list.appendChild(opt);
      });
    }

    async function loadArgs() {
      const path = document.getElementById("script_list").value;
      const res = await fetch("/args", {
        method: "POST",
        body: new URLSearchParams({ path }),
      });
      const data = await res.json();
      const textarea = document.getElementById("args_input");
      if (data.args.length === 0) textarea.value = "# æ— å‚æ•°";
      else textarea.value = data.args.map(a => `${a.name} - ${a.help}`).join("\n");
    }

    function run() {
      const python_path = document.getElementById("python_path").value;
      const script_path = document.getElementById("script_list").value;
      const args_str = document.getElementById("args_input").value.trim();
      const output = document.getElementById("output");
      output.textContent = "";

      const ws = new WebSocket(`ws://${window.location.host}/ws/run`);
      ws.onopen = () => {
        ws.send(JSON.stringify({
          python_path,
          script_path,
          args: args_str.split(" ").filter(x => x)
        }));
      };
      ws.onmessage = (e) => {
        output.textContent += e.data + "\n";
        output.scrollTop = output.scrollHeight;
      };
    }
  </script>
</body>
</html>